<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controller</title>
<style>
  * {margin:0; padding:0; box-sizing:border-box;}
  body, html {
    width:100%; height:100%; font-family: 'Segoe UI', sans-serif;
    overflow:hidden; background: linear-gradient(135deg, #000000, #0a0a1a, #101035, #0a0a1a); color:#f0f0f0;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
  }

  h1 {position:absolute; top:10%; left:50%; transform:translateX(-50%); font-size:2.5em;}
  video {display:none;}
  canvas {position:absolute; top:0; left:0; width:100%; height:100%; z-index:1;}
  #volumeBarContainer {position:absolute; bottom:40px; width:80%; height:20px; background:#333; border-radius:10px;}
  #volumeBar {height:100%; width:0%; background:#00ff99; border-radius:10px;}
</style>
</head>
<body>

<h1>Finger Volume Controller</h1>
<audio id="audioPlayer" autoplay loop></audio>
<video id="webcam" autoplay playsinline></video>
<canvas id="canvas"></canvas>
<div id="volumeBarContainer"><div id="volumeBar"></div></div>

<script type="module">
import {Hands} from 'https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js';
import {Camera} from 'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js';

const audioPlayer = document.getElementById('audioPlayer');
const videoElement = document.getElementById('webcam');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const volumeBar = document.getElementById('volumeBar');

const audioURL = sessionStorage.getItem('audioURL');
if(audioURL) audioPlayer.src = audioURL;

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const hands = new Hands({locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({maxNumHands:1, modelComplexity:1, minDetectionConfidence:0.7, minTrackingConfidence:0.7});

hands.onResults(results=>{
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(results.multiHandLandmarks && results.multiHandLandmarks.length>0){
        const lm = results.multiHandLandmarks[0];
        const thumb = lm[4];
        const index = lm[8];

        const dx = (thumb.x - index.x)*canvas.width;
        const dy = (thumb.y - index.y)*canvas.height;
        const distance = Math.sqrt(dx*dx + dy*dy);

        let volume = Math.min(Math.max((distance-20)/200,0),1);
        audioPlayer.volume = volume;
        volumeBar.style.width = (volume*100)+'%';

        ctx.fillStyle = '#00ff99';
        ctx.beginPath(); ctx.arc(thumb.x*canvas.width, thumb.y*canvas.height,10,0,Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(index.x*canvas.width, index.y*canvas.height,10,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle = '#00ff99';
        ctx.lineWidth = 4;
        ctx.beginPath(); ctx.moveTo(thumb.x*canvas.width, thumb.y*canvas.height);
        ctx.lineTo(index.x*canvas.width, index.y*canvas.height);
        ctx.stroke();
    }
});

const camera = new Camera(videoElement, {
    onFrame: async()=>{ await hands.send({image:videoElement}); },
    width:640, height:480
});
camera.start();

window.addEventListener('resize', ()=>{ canvas.width=window.innerWidth; canvas.height=window.innerHeight; });
</script>

</body>
</html>
